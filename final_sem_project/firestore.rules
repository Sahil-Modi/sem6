rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to get user data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Helper function to check user role
    function hasRole(role) {
      return isSignedIn() && getUserData().role == role;
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone authenticated can read user profiles
      allow read: if isSignedIn();
      
      // Users can create their own profile during registration
      allow create: if isSignedIn() && request.auth.uid == userId;
      
      // Users can update their own profile, admins can update any
      allow update: if isSignedIn() && (
        request.auth.uid == userId || 
        hasRole('admin')
      );
      
      // Only admins can delete users
      allow delete: if isSignedIn() && hasRole('admin');
    }
    
    // Requests collection
    match /requests/{requestId} {
      // Anyone authenticated can read requests
      allow read: if isSignedIn();
      
      // Receivers and organizations can create requests
      allow create: if isSignedIn() && (
        hasRole('receiver') || 
        hasRole('ngo') || 
        hasRole('hospital') || 
        hasRole('admin')
      );
      
      // Organizations and admins can update requests
      allow update: if isSignedIn() && (
        hasRole('admin') || 
        hasRole('ngo') || 
        hasRole('hospital')
      );
      
      // Only admins can delete
      allow delete: if isSignedIn() && hasRole('admin');
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isSignedIn() && 
        resource.data.userId == request.auth.uid;
      
      // System and admins can create notifications
      allow create: if isSignedIn();
      
      // Users can update their own notifications (mark as read)
      allow update: if isSignedIn() && 
        resource.data.userId == request.auth.uid;
      
      // Users can delete their own notifications
      allow delete: if isSignedIn() && 
        resource.data.userId == request.auth.uid;
    }
  }
}
